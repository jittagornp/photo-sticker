<!doctype html>
<html lang="en">

<head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css" integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO"
        crossorigin="anonymous">

    <title>Sticker for Shop</title>
</head>

<body>

    Upload Photo :

    <label>
        <input id="upload_photo" type="file" multiple/>
    </label>

    Upload Sticker :

    <label>
        <input id="upload_sticker" type="file" />
    </label>

    <div id="photos">

    </div>

    <!-- Optional JavaScript -->
    <!-- jQuery first, then Popper.js, then Bootstrap JS -->
    <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo"
        crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js" integrity="sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49"
        crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js" integrity="sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy"
        crossorigin="anonymous"></script>


    <script>
        (function ($) {

            function file2Base64(file, successCallback, errorCallback) {
                let reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = function () {
                    successCallback && successCallback(reader.result);
                };
                reader.onerror = function (error) {
                    errorCallback && errorCallback(error);
                };
            }

            function createCanvasFromImage(src) {
                let canvas = document.createElement('canvas');
                canvas.style.backgroundColor = 'red';

                let context = canvas.getContext('2d');
                let img = new Image();
                img.src = src;
                img.onload = function () {
                    canvas.width = img.width;
                    canvas.height = img.height;
                    context.drawImage(img, 0, 0, img.width, img.height);
                };
                return canvas;
            }

            function convertBase642ImageTag(base64) {
                let $img = $('<img/>');
                $img.attr('src', base64);
                return $img;
            }

            function addImage2Canvas(canvas, src) {
                let context = canvas.getContext('2d');
                let img = new Image();
                img.src = src;
                img.onload = function () {
                    context.drawImage(img, 0, 0, 50, 50);
                };
                return canvas;
            }

            $(function () {

                let $photos = $('#photos');

                $('#upload_photo').change(function () {
                    let $el = $(this);
                    let files = $el[0].files;
                    if (files && files.length) {
                        for (let i = 0; i < files.length; i++) {
                            file2Base64(files[i], function (base64) {
                                let $canvas = $(createCanvasFromImage(base64));

                                let $link = $('<a/>')
                                .attr('href', 'javascript:void(0)')
                                //.attr('target', '_blank')
                                .attr('download', 'download.png')
                                .addClass('photo');
                                
                                $link.append($canvas);
                                $link.on('click', function () {
                                    let imageUrl = $link.find('canvas')[0].toDataURL("image/png");
                                    $link.attr('href', imageUrl);
                                });
                                $photos.append($link);
                            }, function (err) {
                                console.log(err);
                            });
                        }
                    }
                });

                $('#upload_sticker').change(function () {
                    let $el = $(this);
                    let files = $el[0].files;
                    if (files && files.length) {
                        file2Base64(files[0], function (base64) {
                            $photos.find('canvas').each(function () {
                                let $canvas = $(this);
                                addImage2Canvas($canvas[0], base64);
                            });
                        });
                    }
                });
            });
        })(jQuery);
    </script>
</body>

</html>